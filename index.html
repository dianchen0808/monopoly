
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoPoly: SDG Edition</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. PeerJS (P2P Multiplayer) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- 4. Babel (JSX Support) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'glass-white': 'rgba(255, 255, 255, 0.7)',
                        'brand-green': '#10b981',
                        'brand-blue': '#3b82f6',
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Nunito', sans-serif; 
            background: linear-gradient(135deg, #dcfce7 0%, #dbeafe 100%);
            overflow: hidden; 
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .modal-enter { animation: modalPop 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalPop {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .tile-shadow { box-shadow: inset 0 0 15px rgba(0,0,0,0.05); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useRef } = React;

        // --- 1. CONSTANTS ---
        const TileType = { PROPERTY: 'PROPERTY', START: 'START', CHANCE: 'CHANCE', JAIL: 'JAIL', TAX: 'TAX', PARKING: 'PARKING' };

        const INITIAL_TILES = [
            { id: 0, name: 'GO', type: TileType.START, description: 'Collect $200' },
            { id: 1, name: 'Solar Farm', type: TileType.PROPERTY, price: 60, rent: 10, group: 'brown' },
            { id: 2, name: 'Chance', type: TileType.CHANCE },
            { id: 3, name: 'Wind Turbine', type: TileType.PROPERTY, price: 60, rent: 15, group: 'brown' },
            { id: 4, name: 'Eco Tax', type: TileType.TAX, price: 100, description: 'Pay $100' },
            { id: 5, name: 'Hydro Dam', type: TileType.PROPERTY, price: 100, rent: 20, group: 'light_blue' }, 
            { id: 6, name: 'Recycle Hub', type: TileType.PROPERTY, price: 100, rent: 20, group: 'light_blue' },
            { id: 7, name: 'Bio Lab', type: TileType.PROPERTY, price: 120, rent: 25, group: 'light_blue' },
            { id: 8, name: 'Jail', type: TileType.JAIL, description: 'Visit Only' },
            { id: 9, name: 'Comm. Garden', type: TileType.PROPERTY, price: 140, rent: 30, group: 'pink' },
            { id: 10, name: 'Tesla Stn', type: TileType.PROPERTY, price: 140, rent: 30, group: 'pink' }, 
            { id: 11, name: 'Green Uni', type: TileType.PROPERTY, price: 160, rent: 35, group: 'pink' },
            { id: 12, name: 'Free Park', type: TileType.PARKING, description: 'Relax' },
            { id: 13, name: 'E-Bus Depot', type: TileType.PROPERTY, price: 180, rent: 40, group: 'orange' },
            { id: 14, name: 'Chance', type: TileType.CHANCE },
            { id: 15, name: 'Metro', type: TileType.PROPERTY, price: 200, rent: 45, group: 'orange' }, 
            { id: 16, name: 'Forest', type: TileType.PROPERTY, price: 220, rent: 50, group: 'red' },
            { id: 17, name: 'Ocean Cleaner', type: TileType.PROPERTY, price: 220, rent: 50, group: 'red' },
            { id: 18, name: 'Pure Water', type: TileType.PROPERTY, price: 240, rent: 60, group: 'red' },
            { id: 19, name: 'Climate Summit', type: TileType.PROPERTY, price: 350, rent: 100, group: 'blue' },
        ];

        const SDG_QUESTIONS = [
            { q: "SDG 1 aims to end what?", a: ["Poverty", "Hunger", "War", "Disease"], correct: 0 },
            { q: "SDG 13 focuses on...", a: ["Water", "Education", "Climate Action", "Economy"], correct: 2 },
            { q: "Which energy is renewable?", a: ["Coal", "Solar", "Oil", "Gas"], correct: 1 },
            { q: "SDG 14 protects...", a: ["Forests", "Space", "Life Below Water", "Cities"], correct: 2 },
            { q: "Reuse, Reduce, ...", a: ["Rebound", "Recycle", "Reject", "Remake"], correct: 1 },
        ];

        const COLORS = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b']; // Red, Blue, Green, Yellow

        // --- 2. GAME ENGINE ---
        const initialState = {
            players: [],
            currentPlayerIndex: 0,
            tiles: INITIAL_TILES,
            gameStatus: 'LOBBY', // LOBBY, PLAYING, GAME_OVER
            logs: [],
            dice: [1, 1]
        };

        const reducer = (state, action) => {
            switch (action.type) {
                case 'FULL_SYNC': return action.payload; 
                case 'ADD_PLAYER':
                    if (state.players.find(p => p.peerId === action.payload.peerId)) return state;
                    return {
                        ...state,
                        players: [...state.players, { ...action.payload, color: COLORS[state.players.length % 4], money: 1500, position: 0, properties: [] }],
                        logs: [`${action.payload.name} joined!`, ...state.logs]
                    };
                case 'START_GAME':
                    return { ...state, gameStatus: 'PLAYING', logs: ['Game Started! GLHF!', ...state.logs] };
                case 'ROLL_DICE': {
                    const pIndex = state.currentPlayerIndex;
                    const player = state.players[pIndex];
                    const d1 = Math.ceil(Math.random() * 6);
                    const d2 = Math.ceil(Math.random() * 6);
                    const move = d1 + d2;
                    let newPos = (player.position + move) % 20;
                    let money = player.money;
                    let logs = [...state.logs];

                    if (newPos < player.position) {
                        money += 200;
                        logs.unshift(`${player.name} passed GO! +$200`);
                    }

                    // Effects
                    const tile = state.tiles[newPos];
                    if (tile.type === TileType.TAX) {
                        money -= tile.price;
                        logs.unshift(`${player.name} paid Tax $${tile.price}`);
                    }
                    if (tile.type === TileType.CHANCE) {
                        const luck = Math.random();
                        if (luck > 0.5) { money += 50; logs.unshift("Chance: Eco Subsidy +$50"); }
                        else { money -= 30; logs.unshift("Chance: Carbon Fee -$30"); }
                    }

                    const newPlayers = state.players.map((p, i) => i === pIndex ? { ...p, position: newPos, money } : p);
                    return { ...state, dice: [d1, d2], players: newPlayers, logs: [`${player.name} rolled ${move}`, ...logs] };
                }
                case 'END_TURN':
                    return { ...state, currentPlayerIndex: (state.currentPlayerIndex + 1) % state.players.length };
                case 'BUY_TILE': {
                    const { playerId, tileId } = action.payload;
                    const player = state.players.find(p => p.peerId === playerId);
                    const tile = state.tiles[tileId];
                    if (player.money < tile.price) return state;
                    
                    const updatedPlayers = state.players.map(p => p.peerId === playerId ? { ...p, money: p.money - tile.price, properties: [...p.properties, tileId] } : p);
                    const updatedTiles = state.tiles.map(t => t.id === tileId ? { ...t, ownerId: playerId } : t);
                    return { ...state, players: updatedPlayers, tiles: updatedTiles, logs: [`${player.name} bought ${tile.name}`, ...state.logs] };
                }
                case 'PAY_RENT': {
                    const { fromId, toId, amount } = action.payload;
                    return {
                        ...state,
                        players: state.players.map(p => {
                            if (p.peerId === fromId) return { ...p, money: p.money - amount };
                            if (p.peerId === toId) return { ...p, money: p.money + amount };
                            return p;
                        }),
                        logs: [`Rent paid: $${amount}`, ...state.logs]
                    };
                }
                default: return state;
            }
        };

        // --- 3. COMPONENTS ---

        const IconDice = ({ val }) => (
            <svg viewBox="0 0 100 100" className="w-full h-full bg-white rounded-xl shadow-inner border border-slate-200">
                {val === 1 && <circle cx="50" cy="50" r="12" fill="#333"/>}
                {val === 2 && <><circle cx="30" cy="30" r="12" fill="#333"/><circle cx="70" cy="70" r="12" fill="#333"/></>}
                {val === 3 && <><circle cx="25" cy="25" r="12" fill="#333"/><circle cx="50" cy="50" r="12" fill="#333"/><circle cx="75" cy="75" r="12" fill="#333"/></>}
                {val === 4 && <><circle cx="30" cy="30" r="12" fill="#333"/><circle cx="70" cy="30" r="12" fill="#333"/><circle cx="30" cy="70" r="12" fill="#333"/><circle cx="70" cy="70" r="12" fill="#333"/></>}
                {val === 5 && <><circle cx="30" cy="30" r="12" fill="#333"/><circle cx="70" cy="30" r="12" fill="#333"/><circle cx="50" cy="50" r="12" fill="#333"/><circle cx="30" cy="70" r="12" fill="#333"/><circle cx="70" cy="70" r="12" fill="#333"/></>}
                {val === 6 && <><circle cx="30" cy="20" r="10" fill="#333"/><circle cx="70" cy="20" r="10" fill="#333"/><circle cx="30" cy="50" r="10" fill="#333"/><circle cx="70" cy="50" r="10" fill="#333"/><circle cx="30" cy="80" r="10" fill="#333"/><circle cx="70" cy="80" r="10" fill="#333"/></>}
            </svg>
        );

        const Modal = ({ title, children, color = "bg-brand-blue" }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
                <div className="glass-panel w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl modal-enter bg-white">
                    <div className={`${color} p-4 text-white text-center font-bold text-lg tracking-wide`}>{title}</div>
                    <div className="p-6">{children}</div>
                </div>
            </div>
        );

        const Instructions = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md">
                <div className="bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl modal-enter">
                    <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 text-white relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-20 text-6xl">üå±</div>
                        <h2 className="text-3xl font-extrabold relative z-10">Welcome to EcoPoly!</h2>
                        <p className="opacity-90 mt-1 relative z-10 font-medium">Sustainability meets Strategy.</p>
                    </div>
                    <div className="p-6 space-y-4 text-slate-700 leading-relaxed max-h-[60vh] overflow-y-auto">
                        <div className="flex items-start gap-3">
                            <div className="bg-emerald-100 text-emerald-700 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0">1</div>
                            <p><strong>Create or Join:</strong> One player creates a game (Host). Others copy the Game ID to join.</p>
                        </div>
                        <div className="flex items-start gap-3">
                            <div className="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0">2</div>
                            <p><strong>Roll & Invest:</strong> Move around the board. Land on unowned properties to buy them by answering SDG questions.</p>
                        </div>
                        <div className="flex items-start gap-3">
                            <div className="bg-rose-100 text-rose-700 w-8 h-8 rounded-full flex items-center justify-center font-bold shrink-0">3</div>
                            <p><strong>Win:</strong> Bankrupt your opponents by collecting rent. Avoid the Eco Tax!</p>
                        </div>
                        
                        <div className="bg-slate-50 p-3 rounded-lg text-sm border border-slate-200 mt-2">
                            <strong>Note:</strong> If connection fails, please ensure you are not on a restricted corporate firewall.
                        </div>
                    </div>
                    <div className="p-4 border-t bg-slate-50 flex justify-end">
                        <button onClick={onClose} className="bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95">
                            Start Playing
                        </button>
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [state, dispatch] = useReducer(reducer, initialState);
            
            // Networking State
            const [myId, setMyId] = useState(null);
            const [hostIdInput, setHostIdInput] = useState('');
            const [nameInput, setNameInput] = useState('Player ' + Math.floor(Math.random()*100));
            const [isHost, setIsHost] = useState(false);
            const [peer, setPeer] = useState(null);
            const [conn, setConn] = useState(null); 
            const [conns, setConns] = useState([]);
            const [msg, setMsg] = useState('Initializing network...');
            const [networkStatus, setNetworkStatus] = useState('loading'); // loading, ready, error
            const [copyFeedback, setCopyFeedback] = useState('Copy ID');
            
            const [showHelp, setShowHelp] = useState(true);
            const [activeModal, setActiveModal] = useState(null);

            // 1. Initialize PeerJS (The Fix)
            useEffect(() => {
                // FIXED CONFIGURATION FOR GITHUB PAGES
                const p = new Peer(undefined, {
                    host: '0.peerjs.com',
                    port: 443,
                    secure: true, // CRITICAL: Must be true for HTTPS
                    debug: 1,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' } // Fallback STUN
                        ]
                    }
                });

                p.on('open', (id) => { 
                    console.log('My Peer ID:', id);
                    setMyId(id); 
                    setMsg('Ready to play.'); 
                    setNetworkStatus('ready');
                });

                p.on('error', (err) => {
                    console.error('Peer Error:', err);
                    setMsg('Error: ' + (err.type === 'peer-unavailable' ? 'Game ID not found' : 'Connection failed'));
                    setNetworkStatus('error');
                });
                
                // HOST LOGIC
                p.on('connection', (c) => {
                    c.on('open', () => {
                        console.log('New client connected:', c.peer);
                        setConns(prev => [...prev, c]);
                        
                        // Sync current state immediately to new joiner
                        c.send({ type: 'FULL_SYNC', payload: state });

                        c.on('data', (data) => {
                            if (data.type === 'ACTION') {
                                dispatch(data.payload);
                            } else if (data.type === 'JOIN') {
                                dispatch({ type: 'ADD_PLAYER', payload: data.payload });
                            }
                        });
                    });
                });

                setPeer(p);
                return () => p.destroy();
            }, []); // Empty dependency array = run once

            // 2. Broadcast State Updates (Host Only)
            useEffect(() => {
                if (isHost && conns.length > 0) {
                    conns.forEach(c => {
                        if (c.open) c.send({ type: 'FULL_SYNC', payload: state });
                    });
                }
            }, [state, isHost, conns]);

            // 3. Actions
            const createGame = () => {
                if (!myId) return;
                setIsHost(true);
                dispatch({ type: 'ADD_PLAYER', payload: { peerId: myId, name: nameInput } });
                dispatch({ type: 'START_GAME' });
            };

            const joinGame = () => {
                const cleanId = hostIdInput.trim(); // Clean input
                if (!cleanId || !peer) return;
                if (cleanId === myId) { alert("You cannot join yourself!"); return; }

                setMsg('Connecting to host...');
                setNetworkStatus('loading');
                
                const c = peer.connect(cleanId, { reliable: true });
                
                c.on('open', () => {
                    setMsg('Connected! Joining game...');
                    setNetworkStatus('ready');
                    setConn(c);
                    c.send({ type: 'JOIN', payload: { peerId: myId, name: nameInput } });
                });

                c.on('close', () => {
                    setMsg('Connection lost.');
                    setNetworkStatus('error');
                    alert('Host disconnected.');
                });

                // Add error listener for immediate feedback
                c.on('error', (err) => {
                    console.error('Conn Error', err);
                    setMsg('Connection Failed');
                    setNetworkStatus('error');
                });

                c.on('data', (data) => {
                    if (data.type === 'FULL_SYNC') {
                        dispatch({ type: 'FULL_SYNC', payload: data.payload });
                    }
                });
            };

            const sendGameAction = (action) => {
                if (isHost) {
                    dispatch(action);
                } else if (conn && conn.open) {
                    conn.send({ type: 'ACTION', payload: action });
                }
            };

            const copyIdToClipboard = () => {
                if (myId) {
                    navigator.clipboard.writeText(myId);
                    setCopyFeedback('Copied!');
                    setTimeout(() => setCopyFeedback('Copy ID'), 2000);
                }
            };

            // 4. Game Logic
            const myPlayer = state.players.find(p => p.peerId === myId);
            const isMyTurn = state.players[state.currentPlayerIndex]?.peerId === myId;
            const prevPosRef = useRef(0);

            useEffect(() => {
                if (!myPlayer || !isMyTurn) return;
                if (myPlayer.position !== prevPosRef.current) {
                    const tile = state.tiles[myPlayer.position];
                    setTimeout(() => {
                        if (tile.type === TileType.PROPERTY) {
                            if (!tile.ownerId) {
                                const q = SDG_QUESTIONS[Math.floor(Math.random() * SDG_QUESTIONS.length)];
                                setActiveModal({ type: 'QUIZ', tile, q });
                            } else if (tile.ownerId !== myId) {
                                setActiveModal({ type: 'RENT', tile, amount: tile.rent });
                            }
                        }
                    }, 800);
                    prevPosRef.current = myPlayer.position;
                }
            }, [myPlayer?.position, isMyTurn]);

            // 5. Grid Layout
            const getGridStyle = (i) => {
                let col, row;
                if (i <= 5) { row = 6; col = 6 - i; }
                else if (i <= 10) { row = 6 - (i - 5); col = 1; }
                else if (i <= 15) { row = 1; col = 1 + (i - 10); }
                else { row = 1 + (i - 15); col = 6; }
                return { gridColumn: col, gridRow: row };
            };

            // --- RENDER ---

            // Help Button
            const HelpBtn = () => (
                <button onClick={() => setShowHelp(true)} className="fixed top-4 right-4 z-40 bg-white/90 backdrop-blur shadow-lg rounded-full w-10 h-10 flex items-center justify-center font-bold text-slate-700 hover:bg-white hover:scale-110 transition border border-slate-200">
                    ?
                </button>
            );

            // Lobby View
            if (state.gameStatus === 'LOBBY') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
                        {/* Background Decoration */}
                        <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-emerald-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
                        <div className="absolute top-[-10%] right-[-10%] w-[50%] h-[50%] bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>

                        {showHelp && <Instructions onClose={() => setShowHelp(false)} />}
                        {!showHelp && <HelpBtn />}
                        
                        <div className="glass-panel max-w-md w-full p-8 rounded-3xl text-center space-y-6 relative z-10 shadow-2xl border-white/40">
                            <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500 drop-shadow-sm mb-2">EcoPoly</h1>
                            
                            {/* Network Status Indicator */}
                            <div className="flex justify-center items-center gap-2 mb-4">
                                <span className={`h-3 w-3 rounded-full ${networkStatus === 'ready' ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]' : networkStatus === 'error' ? 'bg-red-500' : 'bg-yellow-400 animate-pulse'}`}></span>
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">{networkStatus === 'ready' ? 'Online' : msg}</span>
                            </div>

                            <div className="space-y-2 text-left">
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">Your Name</label>
                                <input className="w-full p-4 bg-white/60 border border-white rounded-2xl focus:ring-2 ring-emerald-400 outline-none transition font-bold text-slate-700 shadow-sm" value={nameInput} onChange={e => setNameInput(e.target.value)} />
                            </div>

                            {networkStatus === 'loading' ? (
                                <div className="p-8 text-slate-400 font-bold animate-pulse">Initializing Network...</div>
                            ) : (
                                <div className="space-y-4">
                                    <button onClick={createGame} disabled={networkStatus!=='ready'} className="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-4 rounded-2xl font-bold shadow-lg shadow-emerald-200 hover:shadow-xl transform hover:-translate-y-1 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                        Create New Game
                                    </button>
                                    
                                    <div className="relative flex py-2 items-center">
                                        <div className="flex-grow border-t border-slate-300"></div>
                                        <span className="flex-shrink mx-4 text-slate-400 text-xs font-bold uppercase tracking-wider">OR JOIN FRIEND</span>
                                        <div className="flex-grow border-t border-slate-300"></div>
                                    </div>

                                    <div className="flex gap-2">
                                        <input className="flex-1 p-3 bg-white/60 border border-white rounded-2xl outline-none text-center font-mono text-sm shadow-inner placeholder-slate-400" 
                                               placeholder="Paste Game ID Here" 
                                               value={hostIdInput} 
                                               onChange={e => setHostIdInput(e.target.value)} />
                                        <button onClick={joinGame} disabled={networkStatus!=='ready'} className="bg-blue-500 text-white px-6 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-600 transition disabled:opacity-50">Join</button>
                                    </div>
                                    <div className="text-xs text-rose-500 font-bold min-h-[20px]">{networkStatus === 'error' ? msg : ''}</div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Game View
            return (
                <div className="h-screen w-full flex flex-col md:flex-row items-center justify-center bg-slate-100 overflow-hidden relative">
                    {showHelp && <Instructions onClose={() => setShowHelp(false)} />}
                    <HelpBtn />

                    {/* Left Panel: Players */}
                    <div className="md:absolute md:left-6 md:top-6 md:bottom-6 w-full md:w-72 glass-panel md:rounded-3xl flex flex-col z-20 md:z-10 order-2 md:order-1 h-[25vh] md:h-auto border-t md:border-t-0 shadow-xl">
                        <div className="p-4 border-b border-slate-200/50 flex justify-between items-center bg-white/40">
                            <span className="font-bold text-slate-700">Players</span>
                            <button className={`text-[10px] px-3 py-1.5 rounded-full font-bold transition flex items-center gap-1 ${copyFeedback==='Copied!'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700 hover:bg-blue-200'}`} onClick={copyIdToClipboard}>
                                {copyFeedback}
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-2">
                            {state.players.map((p, i) => (
                                <div key={i} className={`p-3 rounded-2xl flex justify-between items-center transition-all ${state.currentPlayerIndex === i ? 'bg-white shadow-md ring-2 ring-emerald-400' : 'hover:bg-white/40'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full shadow-md flex items-center justify-center text-white font-bold text-sm border-2 border-white" style={{backgroundColor: p.color}}>{p.name[0]}</div>
                                        <div className="flex flex-col">
                                            <span className="text-sm font-bold text-slate-800">{p.name} {p.peerId === myId ? '(You)' : ''}</span>
                                            <span className="text-[10px] text-slate-500 font-bold uppercase tracking-wide">Pos: {state.tiles[p.position].name}</span>
                                        </div>
                                    </div>
                                    <span className="font-mono font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">${p.money}</span>
                                </div>
                            ))}
                        </div>
                        <div className="h-32 bg-slate-900/5 p-3 overflow-y-auto text-xs font-mono space-y-1.5 border-t border-slate-200/50 text-slate-600">
                            {state.logs.map((l, i) => <div key={i} className="opacity-80 border-l-2 border-slate-300 pl-2">{l}</div>)}
                        </div>
                    </div>

                    {/* Center: Board */}
                    <div className="flex-1 w-full h-full flex items-center justify-center order-1 md:order-2 p-4 md:p-0">
                        <div className="relative bg-white rounded-3xl shadow-2xl border-[12px] border-slate-800 box-border overflow-hidden ring-4 ring-black/10" 
                             style={{ width: '95vmin', height: '95vmin', maxWidth: '800px', maxHeight: '800px' }}>
                            
                            <div className="w-full h-full grid grid-cols-6 grid-rows-6 bg-slate-100 gap-[1px]">
                                
                                {state.tiles.map((tile, i) => {
                                    const style = getGridStyle(i);
                                    const owner = state.players.find(p => p.peerId === tile.ownerId);
                                    const isCorner = tile.type !== TileType.PROPERTY;
                                    
                                    const groupColor = 
                                        tile.group === 'brown' ? 'bg-amber-700' : 
                                        tile.group === 'light_blue' ? 'bg-sky-400' :
                                        tile.group === 'pink' ? 'bg-pink-400' :
                                        tile.group === 'orange' ? 'bg-orange-400' :
                                        tile.group === 'red' ? 'bg-red-500' :
                                        tile.group === 'blue' ? 'bg-blue-600' : 'bg-slate-300';

                                    return (
                                        <div key={i} style={style} className={`relative flex flex-col overflow-hidden ${isCorner ? 'bg-slate-50 z-10' : 'bg-white'}`}>
                                            {/* Property Color Bar */}
                                            {!isCorner && <div className={`h-1/5 w-full ${groupColor} border-b border-black/10`}></div>}
                                            
                                            {/* Tile Content */}
                                            <div className="flex-1 flex flex-col items-center justify-center p-1 text-center relative">
                                                <span className="text-[1.4vmin] font-extrabold leading-tight text-slate-700 z-10">{tile.name}</span>
                                                {!isCorner && !owner && <span className="text-[1.2vmin] text-slate-400 mt-[0.5vmin] font-mono">${tile.price}</span>}
                                                {isCorner && <span className="text-[4vmin] drop-shadow-sm">{tile.id===0?'üèÅ':tile.id===4?'üí∏':tile.id===8?'‚õìÔ∏è':tile.id===12?'üå≤':'üé≤'}</span>}
                                                
                                                {/* Owner Tint */}
                                                {owner && <div className="absolute inset-0 opacity-10" style={{backgroundColor: owner.color}}></div>}
                                            </div>
                                            
                                            {/* Owner Border Marker */}
                                            {owner && <div className="absolute inset-0 border-[4px]" style={{borderColor: owner.color}}></div>}

                                            {/* Players on Tile */}
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none gap-1 flex-wrap content-center px-1">
                                                {state.players.filter(p => p.position === i).map(p => (
                                                    <div key={p.peerId} className="w-[3vmin] h-[3vmin] rounded-full border-2 border-white shadow-lg z-20 transform transition-all duration-500" style={{backgroundColor: p.color}}></div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}

                                {/* Center Hub */}
                                <div className="col-start-2 col-end-6 row-start-2 row-end-6 bg-slate-50 flex flex-col items-center justify-center relative pattern-bg">
                                    <div className="absolute inset-0 opacity-5 bg-[radial-gradient(circle,_var(--tw-gradient-stops))] from-slate-900 to-transparent"></div>
                                    <h1 className="text-[9vmin] font-black text-slate-900/5 -rotate-12 select-none absolute tracking-tighter">EcoPoly</h1>
                                    
                                    <div className="z-10 flex flex-col items-center gap-6 w-full max-w-[60%]">
                                        <div className="flex gap-4 h-[10vmin] w-[22vmin] justify-center">
                                            <div className="h-full aspect-square"><IconDice val={state.dice[0]} /></div>
                                            <div className="h-full aspect-square"><IconDice val={state.dice[1]} /></div>
                                        </div>
                                        
                                        {isMyTurn ? (
                                            <div className="flex gap-3 w-full">
                                                <button onClick={() => sendGameAction({ type: 'ROLL_DICE' })} className="flex-1 bg-gradient-to-b from-emerald-400 to-emerald-600 text-white py-3 rounded-xl font-bold text-[2vmin] shadow-[0_4px_0_rgb(6,95,70)] hover:translate-y-[2px] hover:shadow-[0_2px_0_rgb(6,95,70)] active:translate-y-[4px] active:shadow-none transition-all">
                                                    ROLL
                                                </button>
                                                <button onClick={() => sendGameAction({ type: 'END_TURN' })} className="bg-slate-200 text-slate-500 px-4 py-3 rounded-xl font-bold text-[2vmin] hover:bg-slate-300 transition">
                                                    SKIP
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="bg-white/60 backdrop-blur px-6 py-2 rounded-full font-bold text-slate-500 shadow-sm border border-slate-200 text-[1.5vmin] animate-pulse">
                                                Waiting for {state.players[state.currentPlayerIndex]?.name}...
                                            </div>
                                        )}
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    {activeModal && activeModal.type === 'QUIZ' && (
                        <Modal title="SDG Quiz" color="bg-gradient-to-r from-blue-500 to-indigo-600">
                            <p className="font-bold text-lg text-slate-800 mb-6 leading-tight">{activeModal.q.q}</p>
                            <div className="grid grid-cols-1 gap-3">
                                {activeModal.q.a.map((opt, i) => (
                                    <button key={i} className="text-left p-4 rounded-xl border-2 border-slate-100 hover:border-blue-400 hover:bg-blue-50 font-bold transition text-slate-600 active:scale-[0.98]"
                                        onClick={() => {
                                            if (i === activeModal.q.correct) {
                                                setActiveModal(null);
                                                sendGameAction({ type: 'BUY_TILE', payload: { playerId: myId, tileId: activeModal.tile.id } });
                                            } else {
                                                setActiveModal(null);
                                                sendGameAction({ type: 'END_TURN' }); 
                                                alert("Incorrect! You missed the investment opportunity.");
                                            }
                                        }}>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </Modal>
                    )}

                    {activeModal && activeModal.type === 'RENT' && (
                        <Modal title="Pay Rent" color="bg-gradient-to-r from-rose-500 to-pink-600">
                            <div className="text-center space-y-6">
                                <div className="w-16 h-16 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto text-2xl font-bold">üí∏</div>
                                <div>
                                    <p className="text-slate-500 text-sm font-bold uppercase tracking-wider">Property</p>
                                    <p className="text-xl font-black text-slate-800">{activeModal.tile.name}</p>
                                </div>
                                <div>
                                    <p className="text-slate-500 text-sm font-bold uppercase tracking-wider">Amount</p>
                                    <p className="text-4xl font-black text-rose-500">${activeModal.amount}</p>
                                </div>
                                <button onClick={() => {
                                    sendGameAction({ type: 'PAY_RENT', payload: { fromId: myId, toId: activeModal.tile.ownerId, amount: activeModal.amount } });
                                    setActiveModal(null);
                                }} className="w-full bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-slate-900 transition">
                                    Pay Rent
                                </button>
                            </div>
                        </Modal>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
