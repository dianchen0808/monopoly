
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPoly: SDG Edition</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. PeerJS for P2P Multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- 4. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'board-bg': '#dcfce7',
                        'tile-bg': '#ffffff',
                    },
                    boxShadow: {
                        'tile': 'inset 0 0 0 1px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.05)',
                        'inner-strong': 'inset 0 2px 8px 0 rgba(0, 0, 0, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fredoka:wght@500;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0fdf4; 
            overflow: hidden; 
            touch-action: manipulation;
        }
        
        h1, h2, h3, .brand-font { font-family: 'Fredoka', sans-serif; }

        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .pattern-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useReducer, useRef } = React;

        // --- 1. CONSTANTS & DATA ---
        const TileType = {
            PROPERTY: 'PROPERTY',
            START: 'START',
            CHANCE: 'CHANCE',
            JAIL: 'JAIL',
            TAX: 'TAX',
            PARKING: 'PARKING'
        };

        const INITIAL_TILES = [
            { id: 0, name: 'GO', type: TileType.START, description: 'Collect $200' },
            { id: 1, name: 'Solar Field', type: TileType.PROPERTY, price: 60, rent: 2, group: 'brown' },
            { id: 2, name: 'Community Chest', type: TileType.CHANCE },
            { id: 3, name: 'Wind Farm', type: TileType.PROPERTY, price: 60, rent: 4, group: 'brown' },
            { id: 4, name: 'Carbon Tax', type: TileType.TAX, price: 100, description: 'Pay $100' },
            { id: 5, name: 'Hydro Plant', type: TileType.PROPERTY, price: 100, rent: 6, group: 'light_blue' }, // Corner (Bottom Left)
            { id: 6, name: 'Recycling Ctr', type: TileType.PROPERTY, price: 100, rent: 6, group: 'light_blue' },
            { id: 7, name: 'Bio Lab', type: TileType.PROPERTY, price: 120, rent: 8, group: 'light_blue' },
            { id: 8, name: 'Eco Prison', type: TileType.JAIL, description: 'Just Visiting' },
            { id: 9, name: 'Urban Garden', type: TileType.PROPERTY, price: 140, rent: 10, group: 'pink' },
            { id: 10, name: 'Green School', type: TileType.PROPERTY, price: 140, rent: 10, group: 'pink' }, // Corner (Top Left)
            { id: 11, name: 'Eco Uni', type: TileType.PROPERTY, price: 160, rent: 12, group: 'pink' },
            { id: 12, name: 'Public Park', type: TileType.PARKING, description: 'Free Resting' },
            { id: 13, name: 'Electric Bus', type: TileType.PROPERTY, price: 180, rent: 14, group: 'orange' },
            { id: 14, name: 'Chance', type: TileType.CHANCE },
            { id: 15, name: 'Metro Line', type: TileType.PROPERTY, price: 200, rent: 16, group: 'orange' }, // Corner (Top Right)
            { id: 16, name: 'Forest Reserve', type: TileType.PROPERTY, price: 220, rent: 18, group: 'red' },
            { id: 17, name: 'Ocean Cleanup', type: TileType.PROPERTY, price: 220, rent: 18, group: 'red' },
            { id: 18, name: 'Clean Water', type: TileType.PROPERTY, price: 240, rent: 20, group: 'red' },
            { id: 19, name: 'Global Summit', type: TileType.PROPERTY, price: 350, rent: 35, group: 'blue' },
        ];

        // Adjusted map to standard Monopoly Layout for 20 tiles (5 per side)
        // Bottom: 0 (Right), 1, 2, 3, 4, 5 (Left)
        // Left: 5 (Bottom), 6, 7, 8, 9, 10 (Top)
        // Top: 10 (Left), 11, 12, 13, 14, 15 (Right)
        // Right: 15 (Top), 16, 17, 18, 19, 0 (Bottom)

        const SDG_QUESTIONS = [
            { id: 1, question: "Which SDG aims to end poverty in all its forms everywhere?", options: ["Goal 1: No Poverty", "Goal 5: Gender Equality", "Goal 13: Climate Action", "Goal 10: Reduced Inequalities"], correctIndex: 0 },
            { id: 2, question: "What is the main focus of SDG 13?", options: ["Life Below Water", "Quality Education", "Climate Action", "Zero Hunger"], correctIndex: 2 },
            { id: 3, question: "Which goal promotes inclusive and equitable quality education?", options: ["Goal 3", "Goal 4", "Goal 8", "Goal 9"], correctIndex: 1 },
            { id: 4, question: "SDG 7 focuses on affordable and clean...?", options: ["Water", "Energy", "Air", "Food"], correctIndex: 1 },
            { id: 5, question: "Which goal aims to conserve and sustainably use the oceans?", options: ["Goal 15: Life on Land", "Goal 6: Clean Water", "Goal 14: Life Below Water", "Goal 12: Responsible Consumption"], correctIndex: 2 },
            { id: 6, question: "Which SDG aims to achieve gender equality?", options: ["Goal 10", "Goal 1", "Goal 5", "Goal 16"], correctIndex: 2 },
            { id: 7, question: "Goal 11 focuses on making cities...?", options: ["Rich and exclusive", "Inclusive, safe, resilient and sustainable", "Big and industrial", "Car-centric"], correctIndex: 1 },
        ];

        const PLAYER_COLORS = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'];

        // --- 2. ICONS ---
        const Icons = {
            Dice: ({ val }) => {
                const dots = {
                    1: [[50,50]],
                    2: [[25,25], [75,75]],
                    3: [[25,25], [50,50], [75,75]],
                    4: [[25,25], [25,75], [75,25], [75,75]],
                    5: [[25,25], [25,75], [50,50], [75,25], [75,75]],
                    6: [[25,25], [25,50], [25,75], [75,25], [75,50], [75,75]]
                };
                return (
                    <svg width="40" height="40" viewBox="0 0 100 100" className="bg-white rounded-lg border-2 border-slate-700 shadow-sm">
                        {dots[val]?.map(([cx, cy], i) => <circle key={i} cx={cx} cy={cy} r="10" fill="#1e293b" />)}
                    </svg>
                );
            },
        };

        // --- 3. GAME LOGIC (REDUCER) ---
        const initialState = {
            players: [],
            currentPlayerIndex: 0,
            tiles: INITIAL_TILES,
            gameStatus: 'LOBBY',
            logs: ['Welcome to EcoPoly!'],
            dice: [1, 1],
            winner: null
        };

        const gameReducer = (state, action) => {
            switch (action.type) {
                case 'JOIN_GAME': {
                    if (state.players.find(p => p.peerId === action.payload.peerId)) return state;
                    const newPlayer = { ...action.payload, color: PLAYER_COLORS[state.players.length % 4] };
                    return {
                        ...state,
                        players: [...state.players, newPlayer],
                        logs: [`${newPlayer.name} joined.`, ...state.logs],
                    };
                }
                case 'RESET_GAME': {
                    return {
                        ...initialState,
                        gameStatus: 'PLAYING',
                        players: state.players.map(p => ({
                            ...p, money: 1500, position: 0, isJailed: false, properties: []
                        })),
                        logs: ['Game started!'],
                    };
                }
                case 'SYNC_STATE': return action.payload;
                case 'ROLL_DICE': {
                    const pIndex = state.currentPlayerIndex;
                    const player = state.players[pIndex];
                    const d1 = Math.ceil(Math.random() * 6);
                    const d2 = Math.ceil(Math.random() * 6);
                    const total = d1 + d2;
                    let newLogs = [...state.logs];
                    let money = player.money;
                    
                    let newPos = (player.position + total) % 20;
                    if (newPos < player.position) {
                        money += 200;
                        newLogs.unshift(`${player.name} passed GO! +$200`);
                    }

                    const landedTile = state.tiles[newPos];
                    if (landedTile.type === TileType.TAX) {
                        money -= landedTile.price;
                        newLogs.unshift(`${player.name} paid Tax $${landedTile.price}`);
                    }
                    if (landedTile.type === TileType.CHANCE) {
                        if (Math.random() > 0.5) { money += 50; newLogs.unshift("Chance: Grant +$50"); }
                        else { money -= 30; newLogs.unshift("Chance: Fine -$30"); }
                    }

                    return {
                        ...state,
                        dice: [d1, d2],
                        players: state.players.map((p, i) => i === pIndex ? { ...p, position: newPos, money } : p),
                        logs: [`${player.name} rolled ${total}.`, ...newLogs]
                    };
                }
                case 'BUY_PROPERTY': {
                    const player = state.players[state.currentPlayerIndex];
                    const { tileId } = action.payload;
                    const tile = state.tiles[tileId];
                    if (player.money >= tile.price) {
                        return {
                            ...state,
                            players: state.players.map((p, i) => i === state.currentPlayerIndex ? { ...p, money: p.money - tile.price, properties: [...p.properties, tileId] } : p),
                            tiles: state.tiles.map(t => t.id === tileId ? { ...t, ownerId: player.peerId } : t),
                            logs: [`${player.name} bought ${tile.name}.`, ...state.logs]
                        }
                    }
                    return state;
                }
                case 'PAY_RENT': {
                    const { amount, to } = action.payload;
                    const payer = state.players[state.currentPlayerIndex];
                    const receiver = state.players.find(p => p.peerId === to);
                    
                    if (payer.money < amount) {
                        return { ...state, gameStatus: 'GAME_OVER', winner: receiver.name, logs: [`${payer.name} bankrupt!`, ...state.logs] };
                    }

                    return {
                        ...state,
                        players: state.players.map(p => {
                            if (p.peerId === payer.peerId) return { ...p, money: p.money - amount };
                            if (p.peerId === to) return { ...p, money: p.money + amount };
                            return p;
                        }),
                        logs: [`${payer.name} paid rent $${amount} to ${receiver.name}.`, ...state.logs]
                    };
                }
                case 'END_TURN':
                    return { ...state, currentPlayerIndex: (state.currentPlayerIndex + 1) % state.players.length };
                default: return state;
            }
        };

        // --- 4. COMPONENTS ---

        const ModalManager = ({ modal, onClose, onAction }) => {
            if (!modal) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-pop">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border-4 border-slate-800">
                        <div className={`${modal.type === 'QUIZ' ? 'bg-blue-600' : modal.type === 'RENT' ? 'bg-red-500' : 'bg-green-600'} p-4 text-white flex items-center justify-center gap-2 relative`}>
                            <h3 className="font-bold text-xl brand-font tracking-wide">{modal.title}</h3>
                        </div>
                        <div className="p-6 text-center">
                            {modal.content && <p className="text-lg text-slate-700 font-medium mb-6">{modal.content}</p>}
                            {modal.type === 'QUIZ' && (
                                <div className="grid gap-3">
                                    <p className="text-lg font-bold mb-2">{modal.question}</p>
                                    {modal.options.map((opt, i) => (
                                        <button key={i} onClick={() => onAction('ANSWER', i)} 
                                            className="text-left p-3 border-2 border-slate-200 rounded-xl hover:bg-blue-50 hover:border-blue-500 transition font-medium text-slate-700 active:scale-98">
                                            {opt}
                                        </button>
                                    ))}
                                </div>
                            )}
                            {modal.type === 'BUY' && (
                                <div className="flex gap-4">
                                    <button onClick={() => onAction('CONFIRM_BUY')} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">Buy</button>
                                    <button onClick={onClose} className="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-300 transition">Pass</button>
                                </div>
                            )}
                            {modal.type === 'RENT' && (
                                <button onClick={() => onAction('PAY_RENT')} className="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition">Pay Rent</button>
                            )}
                            {modal.type === 'ALERT' && (
                                <button onClick={onClose} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">Okay</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const BoardTile = ({ tile, players, positionStyle }) => {
            const owner = players.find(p => p.peerId === tile.ownerId);
            const isCorner = [0, 5, 10, 15].includes(tile.id);
            
            // Determine Flex Layout based on position to keep Color Bar on OUTER edge
            // bottom -> color bar at bottom (flex-col-reverse)
            // top -> color bar at top (flex-col)
            // left -> color bar at left (flex-row)
            // right -> color bar at right (flex-row-reverse)
            let flexClass = "flex-col-reverse"; // default bottom
            let colorBarClass = "h-[20%] w-full border-t"; // default horiz bar
            
            if (positionStyle === 'top') {
                flexClass = "flex-col";
                colorBarClass = "h-[20%] w-full border-b";
            } else if (positionStyle === 'left') {
                flexClass = "flex-row";
                colorBarClass = "w-[20%] h-full border-r";
            } else if (positionStyle === 'right') {
                flexClass = "flex-row-reverse";
                colorBarClass = "w-[20%] h-full border-l";
            }

            const getGroupColor = (g) => {
                if(g==='brown') return 'bg-[#8B4513]';
                if(g==='light_blue') return 'bg-[#87CEEB]';
                if(g==='pink') return 'bg-[#FF69B4]';
                if(g==='orange') return 'bg-[#FFA500]';
                if(g==='red') return 'bg-[#FF0000]';
                if(g==='blue') return 'bg-[#0000FF]';
                return 'bg-slate-200';
            };

            return (
                <div className={`w-full h-full relative bg-white border border-slate-300 select-none overflow-hidden ${isCorner ? 'bg-slate-100 z-10' : ''}`}>
                    
                    {/* Content Wrapper */}
                    <div className={`w-full h-full flex ${isCorner ? 'items-center justify-center' : flexClass}`}>
                        
                        {/* Property Color Bar (Outer Edge) */}
                        {tile.type === TileType.PROPERTY && !isCorner && (
                            <div className={`${colorBarClass} ${getGroupColor(tile.group)} border-slate-800`}></div>
                        )}
                        
                        {/* Text Content */}
                        <div className={`flex-1 flex flex-col items-center justify-center p-1 text-center overflow-hidden`}>
                            <span className="text-[8px] md:text-[10px] font-bold leading-tight break-words w-full">{tile.name}</span>
                            
                            {tile.type === TileType.PROPERTY && !owner && (
                                <span className="text-[8px] text-slate-500 font-mono">${tile.price}</span>
                            )}
                            
                            {/* Icons */}
                            {tile.type === TileType.START && <span className="text-xl">üèÅ</span>}
                            {tile.type === TileType.JAIL && <span className="text-xl">‚õìÔ∏è</span>}
                            {tile.type === TileType.PARKING && <span className="text-xl">üÖøÔ∏è</span>}
                            {tile.type === TileType.CHANCE && <span className="text-xl">‚ùì</span>}
                        </div>
                    </div>

                    {/* Owner Token (Small colored square) */}
                    {owner && (
                        <div className="absolute inset-0 border-[3px] pointer-events-none" style={{borderColor: owner.color}}></div>
                    )}

                    {/* Players Overlay */}
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                         <div className="flex flex-wrap justify-center gap-1">
                            {players.filter(p => p.position === tile.id).map(p => (
                                <div key={p.peerId} className="w-3 h-3 md:w-4 md:h-4 rounded-full border border-white shadow-sm" style={{backgroundColor: p.color}}></div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [gameState, dispatch] = useReducer(gameReducer, initialState);
            
            // Network
            const [peerId, setPeerId] = useState('');
            const [hostId, setHostId] = useState('');
            const [myId, setMyId] = useState('');
            const [userName, setUserName] = useState('');
            const [isHost, setIsHost] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [activeModal, setActiveModal] = useState(null);
            const [pendingTileId, setPendingTileId] = useState(null);
            const [isConnecting, setIsConnecting] = useState(false);

            const peerRef = useRef(null);
            const connRef = useRef([]);

            // 1. Initialize Peer on Mount
            useEffect(() => {
                const randomName = 'Player ' + Math.floor(Math.random() * 999);
                setUserName(randomName);

                const initPeer = () => {
                    // Enhanced ICE servers configuration for better connectivity
                    const peer = new Peer(undefined, {
                        debug: 1,
                        secure: true, 
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' },
                                { urls: 'stun:stun3.l.google.com:19302' },
                                { urls: 'stun:stun4.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' }
                            ]
                        }
                    });

                    peer.on('open', (id) => {
                        setMyId(id);
                        console.log('My ID:', id);
                        setStatusMsg('');
                    });

                    peer.on('connection', (conn) => {
                        console.log("Incoming connection from", conn.peer);
                        
                        conn.on('data', (data) => {
                            if (data.type) dispatch(data);
                        });

                        conn.on('open', () => {
                            connRef.current.push(conn);
                            conn.send({ type: 'SYNC_STATE', payload: gameState });
                        });
                    });

                    peer.on('error', (err) => {
                        console.error("Peer Error:", err);
                        if (err.type === 'peer-unavailable') {
                            setStatusMsg("Error: Game ID not found. PeerJS IDs are Case-Sensitive. Check exact characters.");
                            setIsConnecting(false);
                        } else if (err.type === 'network' || err.type === 'disconnected') {
                            setStatusMsg("Network connection lost. Reconnecting...");
                        } else if (err.type === 'browser-incompatible') {
                            setStatusMsg("Error: Browser does not support WebRTC.");
                        } else {
                            setStatusMsg(`Connection Error: ${err.type}`);
                            setIsConnecting(false);
                        }
                    });
                    
                    peer.on('disconnected', () => {
                        setStatusMsg("Disconnected from server. Attempting reconnect...");
                        peer.reconnect();
                    });

                    peerRef.current = peer;
                };

                initPeer();
                return () => {
                    if (peerRef.current) peerRef.current.destroy();
                };
            }, []);

            // Host syncs state to all clients
            useEffect(() => {
                if (isHost && connRef.current.length > 0) {
                    connRef.current.forEach(conn => {
                        if (conn.open) conn.send({ type: 'SYNC_STATE', payload: gameState });
                    });
                }
            }, [gameState, isHost]);

            // Handlers
            const createGame = () => {
                if(!myId) { setStatusMsg("Network initializing, please wait..."); return; }
                setIsHost(true);
                setPeerId(myId);
                const player = { peerId: myId, name: userName, money: 1500, position: 0, isJailed: false, properties: [] };
                dispatch({ type: 'JOIN_GAME', payload: player });
                dispatch({ type: 'RESET_GAME' });
            };

            const joinGame = () => {
                const cleanId = hostId.trim();
                if (!cleanId) {
                    setStatusMsg("Please enter a Game ID");
                    return;
                }
                if (!myId) {
                    setStatusMsg("Network not ready. Try refreshing.");
                    return;
                }
                if (cleanId === myId) {
                    setStatusMsg("You cannot join yourself.");
                    return;
                }

                setIsConnecting(true);
                setStatusMsg("Connecting to Host...");

                const conn = peerRef.current.connect(cleanId, {
                    reliable: true,
                    serialization: 'json'
                });

                // Extended Connection Timeout (15s)
                const timeout = setTimeout(() => {
                    if (!conn.open) {
                        setStatusMsg("Connection timed out. Firewalls might be blocking P2P. Try on 4G/different network.");
                        setIsConnecting(false);
                    }
                }, 15000);

                conn.on('open', () => {
                    clearTimeout(timeout);
                    console.log("Connected to Host!");
                    setStatusMsg(""); 
                    setIsConnecting(false);
                    setPeerId(cleanId);
                    
                    const player = { peerId: myId, name: userName, money: 1500, position: 0, isJailed: false, properties: [] };
                    conn.send({ type: 'JOIN_GAME', payload: player });
                    connRef.current = [conn];
                });

                conn.on('error', (err) => {
                    clearTimeout(timeout);
                    console.error("Conn Error:", err);
                    setStatusMsg("Connection failed.");
                    setIsConnecting(false);
                });
                
                conn.on('close', () => {
                    setStatusMsg("Host disconnected.");
                    setPeerId('');
                });

                conn.on('data', (data) => {
                    if (data.type === 'SYNC_STATE') dispatch({ type: 'SYNC_STATE', payload: data.payload });
                });
            };

            const sendAction = (action) => {
                if (isHost) dispatch(action);
                else if (connRef.current[0]?.open) connRef.current[0].send(action);
            };

            // Game triggers
            const myPlayer = gameState.players.find(p => p.peerId === myId);
            const isMyTurn = myPlayer && gameState.players[gameState.currentPlayerIndex]?.peerId === myId;
            const prevPos = useRef(0);

            useEffect(() => {
                if (!myPlayer) return;
                if (myPlayer.position !== prevPos.current) {
                    const tile = gameState.tiles[myPlayer.position];
                    if (isMyTurn) {
                        if (tile.type === TileType.PROPERTY && !tile.ownerId) {
                            setTimeout(() => {
                                const q = SDG_QUESTIONS[Math.floor(Math.random()*SDG_QUESTIONS.length)];
                                setPendingTileId(tile.id);
                                setActiveModal({ type: 'QUIZ', ...q, title: 'SDG Challenge' });
                            }, 800);
                        } else if (tile.type === TileType.PROPERTY && tile.ownerId && tile.ownerId !== myId) {
                            setTimeout(() => {
                                setActiveModal({ type: 'RENT', title: 'Pay Rent', content: `Owner: ${tile.ownerId === myId ? 'You' : 'Opponent'}`, amount: tile.rent, ownerId: tile.ownerId });
                            }, 800);
                        }
                    }
                    prevPos.current = myPlayer.position;
                }
            }, [myPlayer?.position, isMyTurn]);

            const handleModalAction = (type, data) => {
                if (type === 'ANSWER') {
                    if (data === activeModal.correctIndex) {
                        const tile = gameState.tiles[pendingTileId];
                        setActiveModal({ type: 'BUY', title: 'Correct!', content: `Buy ${tile.name} for $${tile.price}?` });
                    } else {
                        setActiveModal({ type: 'ALERT', title: 'Wrong!', content: 'You missed the chance to buy.' });
                    }
                } else if (type === 'CONFIRM_BUY') {
                    sendAction({ type: 'BUY_PROPERTY', payload: { tileId: pendingTileId } });
                    setActiveModal(null);
                } else if (type === 'PAY_RENT') {
                    sendAction({ type: 'PAY_RENT', payload: { amount: activeModal.amount, to: activeModal.ownerId } });
                    setActiveModal(null);
                }
            };

            // Grid Layout Logic
            const getTileProps = (i) => {
                let style = {};
                let positionStyle = 'bottom';
                
                if (i === 0) { style = { gridArea: '6 / 6 / 7 / 7' }; positionStyle = 'bottom-right';} 
                else if (i <= 4) { style = { gridArea: `6 / ${6-i} / 7 / ${7-i}` }; positionStyle = 'bottom'; } 
                else if (i === 5) { style = { gridArea: '6 / 1 / 7 / 2' }; positionStyle = 'bottom-left';} 
                else if (i <= 9) { style = { gridArea: `${6-(i-5)} / 1 / ${7-(i-5)} / 2` }; positionStyle = 'left'; } 
                else if (i === 10) { style = { gridArea: '1 / 1 / 2 / 2' }; positionStyle = 'top-left';} 
                else if (i <= 14) { style = { gridArea: `1 / ${1+(i-10)} / 2 / ${2+(i-10)}` }; positionStyle = 'top'; } 
                else if (i === 15) { style = { gridArea: '1 / 6 / 2 / 7' }; positionStyle = 'top-right';} 
                else { style = { gridArea: `${1+(i-15)} / 6 / ${2+(i-15)} / 7` }; positionStyle = 'right'; }

                return { style, positionStyle };
            };

            // --- RENDER ---
            if (gameState.gameStatus === 'LOBBY' || !peerId) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-[#dcfce7] to-[#dbeafe] font-sans">
                        <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center space-y-6 border-4 border-slate-800">
                            <div><h1 className="text-5xl font-black text-green-600 tracking-tighter brand-font">EcoPoly üåç</h1></div>
                            <div className="space-y-4">
                                <label className="block text-left text-sm font-bold text-slate-700">Display Name</label>
                                <input className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none font-bold" value={userName} onChange={e=>setUserName(e.target.value)} />
                            </div>
                            <button onClick={createGame} className="w-full bg-green-500 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-green-600 transition">Create Game</button>
                            <div className="relative flex py-2 items-center"><div className="flex-grow border-t-2 border-slate-100"></div><span className="mx-4 text-slate-300 font-bold text-sm">OR JOIN</span><div className="flex-grow border-t-2 border-slate-100"></div></div>
                            <div className="flex flex-col gap-3">
                                <label className="block text-left text-xs font-bold text-slate-400">Paste Game ID (Case Sensitive)</label>
                                {/* Removed 'uppercase' class so users can see exactly what they paste */}
                                <input className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none font-mono text-sm" value={hostId} onChange={e=>setHostId(e.target.value)} placeholder="Enter ID exactly" />
                                {statusMsg && <div className="text-red-500 text-sm font-bold bg-red-50 p-2 rounded-lg">{statusMsg}</div>}
                                <button onClick={joinGame} disabled={isConnecting} className={`text-white px-6 py-3 rounded-xl font-bold shadow-lg transition ${isConnecting ? 'bg-slate-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'}`}>
                                    {isConnecting ? 'Connecting...' : 'Join Game'}
                                </button>
                            </div>
                            {!myId && <p className="text-xs text-slate-400 animate-pulse">Initializing P2P Network...</p>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col md:flex-row bg-slate-100 font-sans overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-full md:w-80 bg-white border-r-2 border-slate-200 flex flex-col z-20 shadow-lg h-[30vh] md:h-full order-2 md:order-1">
                        <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
                            <h2 className="text-xl font-black text-green-700 brand-font">EcoPoly</h2>
                            <div className="text-xs font-mono bg-slate-200 px-2 py-1 rounded cursor-pointer hover:bg-slate-300 transition" onClick={() => navigator.clipboard.writeText(peerId)}>ID: {peerId} üìã</div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {gameState.players.map((p, i) => (
                                <div key={p.peerId} className={`flex justify-between items-center p-3 rounded-xl border-2 ${gameState.currentPlayerIndex === i ? 'border-green-500 bg-green-50' : 'border-slate-100'}`}>
                                    <div className="flex items-center gap-2">
                                        <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" style={{backgroundColor: p.color}}>{p.name[0]}</div>
                                        <div className="flex flex-col"><span className="text-sm font-bold">{p.name}</span></div>
                                    </div>
                                    <div className="font-mono font-bold">${p.money}</div>
                                </div>
                            ))}
                        </div>
                        <div className="h-32 bg-slate-900 text-slate-300 p-2 text-xs font-mono overflow-y-auto">
                            {gameState.logs.map((l,i) => <div key={i}>> {l}</div>)}
                        </div>
                    </div>

                    {/* Board */}
                    <div className="flex-1 bg-board-bg flex items-center justify-center p-2 md:p-8 relative overflow-hidden order-1 md:order-2 h-[70vh] md:h-full">
                        <div className="relative w-full max-w-[650px] aspect-square bg-[#cbd5e1] rounded-lg shadow-2xl border-4 border-slate-800">
                            <div className="grid grid-cols-6 grid-rows-6 gap-[2px] w-full h-full bg-slate-800">
                                
                                {/* Center */}
                                <div className="col-start-2 col-end-6 row-start-2 row-end-6 bg-white flex flex-col items-center justify-center p-4 relative overflow-hidden pattern-bg">
                                    <h1 className="text-4xl md:text-6xl font-black text-slate-800 rotate-[-5deg] opacity-20 absolute">EcoPoly</h1>
                                    <div className="z-10 bg-white/90 p-4 rounded-xl border border-slate-200 shadow-xl flex flex-col items-center gap-4">
                                        <div className="flex gap-4"><Icons.Dice val={gameState.dice[0]} /><Icons.Dice val={gameState.dice[1]} /></div>
                                        <div className="text-center">
                                            <div className="text-xs font-bold text-slate-400 uppercase">Turn</div>
                                            <div className="text-lg font-black" style={{color: gameState.players[gameState.currentPlayerIndex]?.color}}>{gameState.players[gameState.currentPlayerIndex]?.name}</div>
                                        </div>
                                        {isMyTurn && (
                                            <div className="flex gap-2">
                                                <button onClick={() => sendAction({ type: 'ROLL_DICE' })} className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-green-600">Roll</button>
                                                <button onClick={() => sendAction({ type: 'END_TURN' })} className="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-bold shadow hover:bg-slate-300">Skip</button>
                                            </div>
                                        )}
                                        {!isMyTurn && <div className="text-xs text-slate-400 animate-pulse">Waiting...</div>}
                                    </div>
                                </div>

                                {/* Tiles */}
                                {gameState.tiles.map((tile, i) => {
                                    const { style, positionStyle } = getTileProps(i);
                                    return (
                                        <div key={tile.id} style={style}>
                                            <BoardTile tile={tile} players={gameState.players} positionStyle={positionStyle} />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    <ModalManager modal={activeModal} onClose={() => setActiveModal(null)} onAction={handleModalAction} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
